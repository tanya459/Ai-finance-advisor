<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat - AI Finance Advisor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .nav-link { transition: all 0.2s; }
        .nav-link:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        /* Custom scrollbar for chat box */
        #chat-messages::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- Navigation Bar -->
    <nav class="w-full bg-white shadow-lg p-4 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-indigo-700">AI Finance Advisor</h1>
            <div class="flex space-x-4">
                <a href="index.html" class="nav-link px-3 py-2 text-gray-600 hover:text-indigo-500">Home</a>
                <a href="chat.html" class="nav-link px-3 py-2 text-indigo-700 border-b-2 border-indigo-500 font-semibold">Chat</a>
                <a href="upload.html" class="nav-link px-3 py-2 text-gray-600 hover:text-indigo-500">Upload</a>
                <a href="budget.html" class="nav-link px-3 py-2 text-gray-600 hover:text-indigo-500">Budget Plan</a>
            </div>
        </div>
    </nav>

    <!-- Main Content - Chat UI -->
    <main class="w-full max-w-2xl p-4 md:p-8 mt-10 bg-white rounded-xl shadow-2xl flex flex-col h-[70vh]">
        
        <header class="text-center mb-6">
            <h2 class="text-3xl font-bold text-gray-800">Ask Your Financial Questions</h2>
            <p class="text-md text-gray-500">Get quick, general advice from our AI.</p>
        </header>

        <!-- Message Container -->
        <div id="chat-messages" class="flex-grow overflow-y-auto p-4 space-y-4 border border-gray-200 rounded-lg bg-gray-50 mb-4">
            <!-- Initial AI message -->
            <div class="flex justify-start">
                <div class="bg-indigo-100 p-3 rounded-lg max-w-xs md:max-w-md shadow">
                    <p class="text-indigo-800 font-semibold">Advisor</p>
                    <p class="text-sm">Hello! How can I assist you with your finances today? Ask me about savings, budgeting tips, or general advice.</p>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <div class="flex space-x-3">
            <input type="text" id="chat-input" placeholder="Type your question here..."
                   class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                   onkeydown="if(event.keyCode===13) document.getElementById('send-btn').click()">
            <button id="send-btn"
                    class="p-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-200 disabled:opacity-50 flex items-center justify-center space-x-1">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                <span>Send</span>
            </button>
        </div>

    </main>

    <script>
        const API_URL = 'http://127.0.0.1:5000/api/chat';
        const chatInput = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const chatMessages = document.getElementById('chat-messages');

        function appendMessage(sender, text, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-lg max-w-xs md:max-w-md shadow ${isUser ? 'bg-indigo-600 text-white' : 'bg-indigo-100 text-indigo-800'}`;
            
            const senderName = document.createElement('p');
            senderName.className = 'font-semibold mb-0.5';
            senderName.textContent = isUser ? 'You' : 'Advisor';
            
            const textContent = document.createElement('p');
            textContent.className = 'text-sm';
            textContent.textContent = text;
            
            bubble.appendChild(senderName);
            bubble.appendChild(textContent);
            messageDiv.appendChild(bubble);
            chatMessages.appendChild(messageDiv);
            
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
        }

        sendBtn.addEventListener('click', async () => {
            const message = chatInput.value.trim();
            if (message === '') return;

            appendMessage('You', message, true);
            chatInput.value = '';
            sendBtn.disabled = true;

            // Add typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'flex justify-start';
            typingDiv.innerHTML = '<div class="bg-gray-200 p-3 rounded-lg shadow"><span class="animate-pulse text-gray-600">Advisor is typing...</span></div>';
            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message }),
                });

                const data = await response.json();

                // Remove typing indicator before appending result
                chatMessages.removeChild(typingDiv); 

                if (!response.ok) {
                    const errorMessage = data.error || "Could not get a reply from the AI.";
                    appendMessage('Advisor', `❌ Error: ${errorMessage}`, false);
                    return;
                }

                appendMessage('Advisor', data.reply, false);

            } catch (error) {
                console.error('Chat Fetch Error:', error);
                // Remove typing indicator if error occurs
                if (chatMessages.contains(typingDiv)) chatMessages.removeChild(typingDiv);
                appendMessage('Advisor', '❌ Network Error: Could not connect to the backend server.', false);
            } finally {
                sendBtn.disabled = false;
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });
    </script>
</body>
</html>